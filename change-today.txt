
https://github.com/noorjsdivs/shopcartyt




diff --git a/next.config.ts b/next.config.ts
index a9553ae..60b4e3a 100644
--- a/next.config.ts
+++ b/next.config.ts
@@ -48,6 +48,10 @@ const nextConfig: NextConfig = {
         protocol: "https",
         hostname: "cdn.example.com",
       },
+      {
+        protocol: "https",
+        hostname: "22.32.245.79",
+      },
       {
         protocol: "https",
         hostname: "cdn.nbcexpo.co.tz",

diff --git a/src/app/layout.tsx b/src/app/layout.tsx
index fb4fb6a..b6a30bc 100644
--- a/src/app/layout.tsx
+++ b/src/app/layout.tsx
@@ -16,6 +16,7 @@ import { AddressProvider } from "@/providers/address.provider";
 import { NumberingProvider } from "@/providers/numbering.provider";
 import { TicketProvider } from "@/providers/ticket.provider";
 import { PaymentProvider } from "@/providers/payment.provider";
+import { GuestAuthProvider } from "@/providers/guest-auth.provider";
 
 
 export const metadata: Metadata = {
@@ -50,7 +51,8 @@ export default function RootLayout({
                     <TicketProvider>
                       <NumberingProvider>
                         <AddressProvider>
-                          <CartProvider>
+                          <GuestAuthProvider>
+                            <CartProvider>
                             <OrderProvider>
                               <PaymentProvider>
                                 <AccountValidationProvider>
@@ -62,7 +64,8 @@ export default function RootLayout({
                                 </AccountValidationProvider>
                               </PaymentProvider>
                             </OrderProvider>
-                          </CartProvider>
+                            </CartProvider>
+                          </GuestAuthProvider>
                         </AddressProvider>
                       </NumberingProvider>
                     </TicketProvider>
diff --git a/src/components/shop/ProductActions.tsx b/src/components/shop/ProductActions.tsx
index 00fa408..3aa1a52 100644
--- a/src/components/shop/ProductActions.tsx
+++ b/src/components/shop/ProductActions.tsx
@@ -8,6 +8,7 @@ import { Input } from "@/components/ui/input";
 import { Product } from "@/types/product.types";
 import { successMessage, errorMessage } from "@/utils/notification";
 import { useCart } from "@/hooks/useCart";
+import { useGuestAuthFlow } from "@/hooks/use-guest-auth-flow";
 
 interface ProductActionsProps {
   product: Product;
@@ -28,6 +29,7 @@ export const ProductActions: React.FC<ProductActionsProps> = ({
   const [isWishlisted, setIsWishlisted] = useState(false);
 
   const { addToCartWithVariant, isLoading } = useCart();
+  const { requireAuth, isLoading: isAuthLoading } = useGuestAuthFlow();
 
   // Check if product is available
   const availableStock = maxQuantity ?? product.quantity ?? 0;
@@ -61,16 +63,22 @@ export const ProductActions: React.FC<ProductActionsProps> = ({
       return;
     }
 
-    // Add to cart using the cart provider
-    try {
-      await addToCartWithVariant(variantId, quantity,`${quantity} item(s) of ${product.name} added to cart successfully!`);
-
-      // Reset quantity to 1 after successful add
-      setQuantity(1);
-    } catch (error) {
-      errorMessage("Failed to add product to cart. Please try again.");
-      console.error("Add to cart error:", error);
-    }
+    // Use requireAuth to gate the cart action - prompts login/guest if not authenticated
+    requireAuth(async () => {
+      try {
+        await addToCartWithVariant(
+          variantId,
+          quantity,
+          `${quantity} item(s) of ${product.name} added to cart successfully!`
+        );
+
+        // Reset quantity to 1 after successful add
+        setQuantity(1);
+      } catch (error) {
+        errorMessage("Failed to add product to cart. Please try again.");
+        console.error("Add to cart error:", error);
+      }
+    });
   };
 
   const handleBuyNow = () => {
@@ -134,10 +142,10 @@ export const ProductActions: React.FC<ProductActionsProps> = ({
         <div className="flex gap-2 flex-1">
           <Button
             onClick={handleAddToCart}
-            disabled={!isAvailable || isLoading}
+            disabled={!isAvailable || isLoading || isAuthLoading}
             className="flex-1 bg-primary hover:bg-primary/90 transition-all duration-200 sm:hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed text-xs sm:text-sm md:text-base h-9 sm:h-10 md:h-11 px-3 sm:px-4 md:px-6"
           >
-            {isLoading ? "ADDING..." : isAvailable ? "ADD TO CART" : "OUT OF STOCK"}
+            {isLoading || isAuthLoading ? "ADDING..." : isAvailable ? "ADD TO CART" : "OUT OF STOCK"}
           </Button>
           {/* <Button
             variant="outline"
diff --git a/src/components/shop/ShopProductCard.tsx b/src/components/shop/ShopProductCard.tsx
index 00f5deb..c092c5b 100644
--- a/src/components/shop/ShopProductCard.tsx
+++ b/src/components/shop/ShopProductCard.tsx
@@ -8,6 +8,7 @@ import { useRouter } from "next/navigation";
 import Link from "next/link";
 import { successMessage, errorMessage } from "@/utils/notification";
 import { useCart } from "@/hooks/useCart";
+import { useGuestAuthFlow } from "@/hooks/use-guest-auth-flow";
 
 interface ProductCardProps {
   id: string;
@@ -42,6 +43,7 @@ const ShopProductCard = ({
   const [isWishlisted, setIsWishlisted] = useState(false);
   const router = useRouter();
   const { addToCartWithVariant, isLoading } = useCart();
+  const { requireAuth, isLoading: isAuthLoading } = useGuestAuthFlow();
 
   const handleAddToCart = async () => {
     if (!variantId) {
@@ -49,13 +51,16 @@ const ShopProductCard = ({
       return;
     }
 
-    try {
-      await addToCartWithVariant(variantId, 1);
-      successMessage("Product added to cart successfully!");
-    } catch (error) {
-      errorMessage("Failed to add product to cart. Please try again.");
-      console.error("Add to cart error:", error);
-    }
+    // Use requireAuth to gate the cart action - prompts login/guest if not authenticated
+    requireAuth(async () => {
+      try {
+        await addToCartWithVariant(variantId, 1);
+        successMessage("Product added to cart successfully!");
+      } catch (error) {
+        errorMessage("Failed to add product to cart. Please try again.");
+        console.error("Add to cart error:", error);
+      }
+    });
   };
 
   const handleWishlistCart = () => {
@@ -122,9 +127,9 @@ const ShopProductCard = ({
           <button
             className="p-2 bg-white text-primary-950 rounded-full transition-all duration-200 hover:bg-shop-blue-dark hover:scale-110 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
             onClick={handleAddToCart}
-            disabled={isLoading || !variantId}
+            disabled={isLoading || isAuthLoading || !variantId}
           >
-            <ShoppingCart className={cn("w-4 h-4", isLoading && "animate-pulse")} />
+            <ShoppingCart className={cn("w-4 h-4", (isLoading || isAuthLoading) && "animate-pulse")} />
           </button>
 
           <button
diff --git a/src/lib/api/interceptor.ts b/src/lib/api/interceptor.ts
index a28bf4c..08d5564 100644
--- a/src/lib/api/interceptor.ts
+++ b/src/lib/api/interceptor.ts
@@ -18,6 +18,7 @@ export class ApiInterceptors {
   // Token storage keys
   private readonly TOKEN_KEY = "auth_token";
   private readonly TOKEN_BACKUP_KEY = "auth_token_backup";
+  private readonly GUEST_TOKEN_KEY = "guest_auth_token";
 
   private constructor() {
     this.initializeAuthToken();
@@ -46,18 +47,25 @@ export class ApiInterceptors {
   private getStoredToken(): string | null {
     if (typeof window === "undefined") return null;
 
-    const sources = [
+    // Check regular auth tokens first
+    const regularSources = [
       localStorage.getItem(this.TOKEN_KEY),
       sessionStorage.getItem(this.TOKEN_BACKUP_KEY),
       (window as Window & { authTokenBackup?: string }).authTokenBackup,
     ];
 
-    for (const token of sources) {
+    for (const token of regularSources) {
       if (token && this.isValidJWT(token)) {
         return token;
       }
     }
 
+    // Fall back to guest token if no regular token found
+    const guestToken = localStorage.getItem(this.GUEST_TOKEN_KEY);
+    if (guestToken && this.isValidJWT(guestToken)) {
+      return guestToken;
+    }
+
     return null;
   }
 
