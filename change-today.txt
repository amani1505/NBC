"use client";
import Image from "next/image";
import { useEffect, useState, useRef } from "react";
import { Button } from "@/components/ui/button";
import { ChevronDown, ChevronLeft, ChevronRight, Play } from "lucide-react";

interface HeroCardI {
  id: string;
  image: string;
  title: string;
  height: number;
  width: number;
  onClick: (title: string) => void;
}

interface MediaItem {
  url: string;
  type: "image" | "video" | "loading";
}

export type HeroSliderI = {
  id: string;
  title: string;
  subtitle: string;
  description: string;
  backgroundImage: string;
  logoUrl?: string;
  cta1?: string;
  cta2?: string;
  thumbnails: string[];
  heroCards?: HeroCardI[];
  countdownDate?: string;
  countdownLabel?: string;
  cta1Action?: () => void;
  cta2Action?: () => void;
};

type CountdownTime = {
  days: number;
  hours: number;
  minutes: number;
  seconds: number;
};

type HeroProps = {
  height?: string;
  autoplayInterval?: number;
  heroSlide: HeroSliderI;
};

function HeroSlider({
  height = "min-h-[100vh] sm:min-h-[92.8vh]",
  autoplayInterval = 5000,
  heroSlide,
}: HeroProps) {
  const [currentSlide, setCurrentSlide] = useState(0);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [isAutoplayPaused, setIsAutoplayPaused] = useState(false);
  const [isMounted, setIsMounted] = useState(false);
  const [touchStart, setTouchStart] = useState<number | null>(null);
  const [touchEnd, setTouchEnd] = useState<number | null>(null);
  const [countdownTime, setCountdownTime] = useState<CountdownTime>({
    days: 0,
    hours: 0,
    minutes: 0,
    seconds: 0,
  });
  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const countdownRef = useRef<NodeJS.Timeout | null>(null);
  const videoRefs = useRef<(HTMLVideoElement | null)[]>([]);
  const [mediaItems, setMediaItems] = useState<MediaItem[]>([]);

  useEffect(() => {
    setIsMounted(true);
  }, []);

  useEffect(() => {
    const detectMediaTypes = async () => {
      const detectedMedia: MediaItem[] = await Promise.all(
        heroSlide.thumbnails.map(async (url) => {
          try {
            const response = await fetch(url, {
              method: "HEAD",
            });
            const contentType = response.headers.get("content-type") || "";

            if (contentType.startsWith("video/")) {
              return { url, type: "video" as const };
            } else {
              return { url, type: "image" as const };
            }
          } catch (error) {
            console.error("Error detecting media type:", error);
            return { url, type: "image" as const };
          }
        }),
      );

      setMediaItems(detectedMedia);
    };

    if (heroSlide.thumbnails.length > 0) {
      detectMediaTypes();
    }
  }, [heroSlide.thumbnails]);

  const calculateTimeLeft = (targetDate: string): CountdownTime => {
    const difference = +new Date(targetDate) - +new Date();

    if (difference > 0) {
      return {
        days: Math.floor(difference / (1000 * 60 * 60 * 24)),
        hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
        minutes: Math.floor((difference / 1000 / 60) % 60),
        seconds: Math.floor((difference / 1000) % 60),
      };
    }

    return { days: 0, hours: 0, minutes: 0, seconds: 0 };
  };

  useEffect(() => {
    if (heroSlide?.countdownDate && isMounted) {
      const updateCountdown = () => {
        setCountdownTime(calculateTimeLeft(heroSlide.countdownDate!));
      };

      updateCountdown();
      countdownRef.current = setInterval(updateCountdown, 1000);
    }

    return () => {
      if (countdownRef.current) {
        clearInterval(countdownRef.current);
      }
    };
  }, [heroSlide, isMounted]);

  useEffect(() => {
    videoRefs.current.forEach((video, index) => {
      if (video) {
        if (index === currentSlide) {
          video
            .play()
            .catch((err) => console.log("Video autoplay prevented:", err));
        } else {
          video.pause();
          video.currentTime = 0;
        }
      }
    });
  }, [currentSlide]);

  useEffect(() => {
    if (!isAutoplayPaused && isMounted && mediaItems.length > 1) {
      intervalRef.current = setInterval(() => {
        nextSlide();
      }, autoplayInterval);
    }

    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, [
    currentSlide,
    isAutoplayPaused,
    autoplayInterval,
    isMounted,
    mediaItems.length,
  ]);

  const handleTouchStart = (e: React.TouchEvent) => {
    setTouchEnd(null);
    setTouchStart(e.targetTouches[0].clientX);
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    setTouchEnd(e.targetTouches[0].clientX);
  };

  const handleTouchEnd = () => {
    if (!touchStart || !touchEnd) return;

    const distance = touchStart - touchEnd;
    const isLeftSwipe = distance > 50;
    const isRightSwipe = distance < -50;

    if (isLeftSwipe) {
      nextSlide();
    } else if (isRightSwipe) {
      prevSlide();
    }
  };

  const goToSlide = (index: number) => {
    if (isTransitioning) return;
    setIsTransitioning(true);
    setCurrentSlide(index);

    if (intervalRef.current) {
      clearInterval(intervalRef.current);
    }

    setTimeout(() => setIsTransitioning(false), 500);
  };

  const nextSlide = () => {
    if (isTransitioning || mediaItems.length === 0) return;
    setIsTransitioning(true);
    setCurrentSlide((prev) => (prev + 1) % mediaItems.length);
    setTimeout(() => setIsTransitioning(false), 500);
  };

  const prevSlide = () => {
    if (isTransitioning || mediaItems.length === 0) return;
    setIsTransitioning(true);
    setCurrentSlide(
      (prev) => (prev - 1 + mediaItems.length) % mediaItems.length,
    );

    if (intervalRef.current) {
      clearInterval(intervalRef.current);
    }

    setTimeout(() => setIsTransitioning(false), 500);
  };

  const handleMouseEnter = () => {
    setIsAutoplayPaused(true);
  };

  const handleMouseLeave = () => {
    setIsAutoplayPaused(false);
  };

  const formatNumber = (num: number): string => {
    return num.toString().padStart(2, "0");
  };

  return (
    <section
      className={`relative ${height} flex items-center overflow-hidden`}
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
    >
      {/* Sliding Background Images/Videos */}
      <div className="absolute inset-0 z-0">
        {mediaItems.length === 0 ? (
          <div
            className="w-full h-full bg-cover bg-center relative"
            style={{
              backgroundImage: `linear-gradient(to right, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0.3) 100%), url("${heroSlide.backgroundImage}")`,
              backgroundPosition: "center center",
              backgroundSize: "cover",
            }}
          />
        ) : (
          <div
            className="flex transition-transform duration-500 ease-in-out h-full w-full"
            style={{ transform: `translateX(-${currentSlide * 100}%)` }}
          >
            {mediaItems.map((item, index) => (
              <div key={index} className="min-w-full h-full relative">
                {item.type === "video" ? (
                  <div className="relative w-full h-full">
                    <video
                      ref={(el) => {
                        videoRefs.current[index] = el;
                      }}
                      className="w-full h-full object-cover"
                      loop
                      muted
                      playsInline
                    >
                      <source src={item.url} type="video/mp4" />
                    </video>
                    <div
                      className="absolute inset-0 bg-gradient-to-r from-black/70 via-black/50 to-black/30"
                      style={{ pointerEvents: "none" }}
                    />
                  </div>
                ) : (
                  <div
                    className="w-full h-full bg-cover bg-center relative"
                    style={{
                      backgroundImage: `linear-gradient(to right, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0.3) 100%), url("${item.url}")`,
                      backgroundPosition: "center center",
                      backgroundSize: "cover",
                    }}
                    role="img"
                    aria-label={`Background ${index + 1}`}
                  />
                )}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Hero Content */}
      <div className="relative z-10 flex flex-col justify-center space-y-3 px-4 sm:px-8 md:pl-16 lg:pl-40 md:pr-8 lg:pr-10 w-full">
        {/* Logo Section */}
        <div className="space-y-4 sm:space-y-6">
          {heroSlide.logoUrl && (
            <div className="relative">
              <Image
                src={heroSlide.logoUrl}
                alt="event-logo"
                width={120}
                height={120}
                className="relative w-24 sm:w-32 md:w-36 lg:w-40 h-auto"
                unoptimized
              />
            </div>
          )}

          {/* Title and Description */}
          <div className="max-w-full sm:max-w-xl lg:max-w-2xl text-white space-y-3 sm:space-y-4">
            <h2 className="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold leading-tight">
              {heroSlide.title}
            </h2>
            <p className="text-sm sm:text-base md:text-lg whitespace-pre-line leading-relaxed">
              {heroSlide.description}
            </p>
          </div>
        </div>

        {/* Countdown Timer */}
        {heroSlide.countdownDate && isMounted && (
          <div className="mt-2 animate-fade-in">
            {heroSlide.countdownLabel && (
              <p className="text-white/80 text-xs sm:text-sm md:text-base font-medium tracking-wide uppercase mb-1">
                {heroSlide.countdownLabel}
              </p>
            )}
            <div className="text-white text-xl sm:text-2xl md:text-3xl font-bold flex gap-x-2 sm:gap-x-3">
              <div>{formatNumber(countdownTime.days)}D</div>
              <div>:</div>
              <div>{formatNumber(countdownTime.hours)}H</div>
              <div>:</div>
              <div>{formatNumber(countdownTime.minutes)}M</div>
              <div>:</div>
              <div>{formatNumber(countdownTime.seconds)}S</div>
            </div>
          </div>
        )}

        {/* CTA Buttons */}
        {(heroSlide.cta1 || heroSlide.cta2) && (
          <div className="flex flex-col xs:flex-row sm:flex-row gap-3 sm:gap-4 justify-start mb-12 sm:mb-16 md:mb-20 mt-4 sm:mt-6">
            {heroSlide.cta2 && (
              <Button
                variant="outline"
                size="lg"
                className="border border-white text-white hover:bg-white/10 text-sm sm:text-base w-full xs:w-auto"
                onClick={heroSlide.cta2Action}
              >
                {heroSlide.cta2}
              </Button>
            )}

            {heroSlide.cta1 && (
              <Button
                size="lg"
                className="bg-primary text-white hover:bg-primary/90 text-sm sm:text-base w-full xs:w-auto"
                onClick={heroSlide.cta1Action}
              >
                {heroSlide.cta1}
                <ChevronRight className="ml-2 w-4 h-4 sm:w-5 sm:h-5" />
              </Button>
            )}
          </div>
        )}

        {/* Hero Cards */}
        {heroSlide.heroCards && heroSlide.heroCards.length > 0 && (
          <div className="flex gap-2 sm:gap-3 mt-4 sm:mt-7 flex-wrap">
            {heroSlide.heroCards.map((heroCard, index) => (
              <div
                key={heroCard.id || index}
                onClick={() => heroCard.onClick(heroCard.title)}
                className="bg-white/10 backdrop-blur-md rounded-lg p-2 sm:p-3 border border-white/20 shadow-2xl hover:bg-white/15 transition-all duration-300 hover:scale-105 w-[120px] sm:w-[140px] md:w-[146px] h-[100px] sm:h-[110px] md:h-[120px] flex flex-col justify-center items-center gap-y-2 cursor-pointer"
              >
                <div className="text-xl sm:text-2xl md:text-3xl font-bold text-white">
                  <Image
                    src={heroCard.image}
                    alt={heroCard.title}
                    height={heroCard.height}
                    width={heroCard.width}
                    className="w-auto h-auto max-w-full"
                  />
                </div>
                <div className="text-white/70 text-[9px] sm:text-[10px] font-medium uppercase tracking-wider text-center">
                  {heroCard.title}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Scroll Indicator */}
      <div className="absolute bottom-3 sm:bottom-4 right-3 sm:right-8 lg:right-12 z-10 flex flex-col items-center">
        <span className="text-white/70 text-[10px] sm:text-xs md:text-sm mb-1">Scroll</span>
        <div className="w-4 h-7 sm:w-5 sm:h-8 md:w-6 md:h-10 border-2 border-white/30 rounded-full flex justify-center">
          <div className="w-1 h-2 sm:h-2 md:h-3 bg-white/50 rounded-full mt-1 sm:mt-1 md:mt-2 animate-bounce"></div>
        </div>
        <ChevronDown className="w-3 h-3 sm:w-3 sm:h-3 md:w-4 md:h-4 text-white/50 animate-bounce mt-1" />
      </div>

      {/* Slide Indicators - Small Dots */}
      {mediaItems.length > 1 && (
        <div className="absolute bottom-12 sm:bottom-14 md:bottom-16 left-1/2 transform -translate-x-1/2 z-20">
          <div className="flex space-x-2 sm:space-x-2.5">
            {mediaItems.map((item, index) => (
              <button
                key={index}
                onClick={() => goToSlide(index)}
                disabled={isTransitioning}
                className={`relative rounded-full transition-all duration-300 disabled:opacity-50 ${
                  index === currentSlide
                    ? "w-2.5 h-2.5 sm:w-3 sm:h-3 bg-white scale-110"
                    : "w-2 h-2 sm:w-2.5 sm:h-2.5 bg-white/40 hover:bg-white/60"
                }`}
                aria-label={`Go to slide ${index + 1}`}
              >
                <span className="sr-only">
                  {item.type === "video" ? "Video" : "Image"} slide {index + 1}
                </span>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Navigation Arrows */}
      {mediaItems.length > 1 && (
        <>
          <button
            onClick={prevSlide}
            disabled={isTransitioning}
            className="absolute left-2 sm:left-4 top-1/2 transform -translate-y-1/2 z-20 bg-black/20 backdrop-blur-sm hover:bg-black/40 text-white p-2 sm:p-3 rounded-full transition-all duration-300 hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Previous slide"
          >
            <ChevronLeft className="w-5 h-5 sm:w-6 sm:h-6" />
          </button>

          <button
            onClick={nextSlide}
            disabled={isTransitioning}
            className="absolute right-2 sm:right-4 top-1/2 transform -translate-y-1/2 z-20 bg-black/20 backdrop-blur-sm hover:bg-black/40 text-white p-2 sm:p-3 rounded-full transition-all duration-300 hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Next slide"
          >
            <ChevronRight className="w-5 h-5 sm:w-6 sm:h-6" />
          </button>
        </>
      )}

      <style jsx>{`
        @keyframes fade-in {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .animate-fade-in {
          animation: fade-in 0.6s ease-out;
        }

        @media (max-width: 640px) {
          button {
            min-height: 44px;
            min-width: 44px;
          }
        }
      `}</style>
    </section>
  );
}

export default HeroSlider;
